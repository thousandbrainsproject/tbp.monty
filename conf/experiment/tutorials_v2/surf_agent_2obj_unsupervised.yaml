# @package _global_
# Tutorial: Surface agent unsupervised learning on 2 objects (mug, bowl)
#
# This tutorial demonstrates unsupervised learning where the agent explores
# objects without labels. Inline configs show learning module thresholds
# and graph delta thresholds for educational purposes.

defaults:
  - /environment/object_sampler: random_rotation
  - override /logging: csv
  - override /agent_config: surface_habitat

_target_: tbp.monty.frameworks.experiments.object_recognition_experiments.MontyObjectRecognitionExperiment
config:
  # Not running eval here. The only difference between training and evaluation
  # is that during evaluation, no models are updated.
  do_eval: false
  n_train_epochs: 3
  max_train_steps: 2000
  max_total_steps: 5000
  logging:
    python_log_level: INFO
    output_dir: ${path.expanduser:"~/tbp/results/monty/projects"}
    run_name: surf_agent_2obj_unsupervised
  monty_config:
    # Monty class for evidence-based matching
    monty_class: ${monty.class:tbp.monty.frameworks.models.evidence_matching.model.MontyForEvidenceGraphMatching}
    monty_args:
      num_exploratory_steps: 1000
      min_train_steps: 100
    # Motor system: surface policy for unsupervised exploration
    motor_system_config:
      motor_system_class: ${monty.class:tbp.monty.frameworks.models.motor_system.MotorSystem}
      motor_system_args:
        policy_class: ${monty.class:tbp.monty.frameworks.models.motor_policies.SurfacePolicy}
        policy_args:
          action_sampler_class: ${monty.class:tbp.monty.frameworks.actions.action_samplers.ConstantSampler}
    # Connectivity: sensor_module_0 sends to learning_module_0
    sm_to_lm_matrix: [[0]]  # SM0 -> LM0
    lm_to_lm_matrix: [[]]   # No LM-to-LM connections
    sensor_module_configs:
      sensor_module_0:
        sensor_module_class: ${monty.class:tbp.monty.frameworks.models.sensor_modules.HabitatSM}
        sensor_module_args:
          is_surface_sm: true
          sensor_module_id: patch
          features:
            - pose_vectors
            - pose_fully_defined
            - on_object
            - object_coverage
            - rgba
            - hsv
            - min_depth
            - mean_depth
            - principal_curvatures
            - principal_curvatures_log
            - gaussian_curvature
            - mean_curvature
            - gaussian_curvature_sc
            - mean_curvature_sc
          save_raw_obs: false
      sensor_module_1:
        sensor_module_class: ${monty.class:tbp.monty.frameworks.models.sensor_modules.Probe}
        sensor_module_args:
          sensor_module_id: view_finder
          save_raw_obs: false
    learning_module_configs:
      learning_module_0:
        learning_module_class: ${monty.class:tbp.monty.frameworks.models.evidence_matching.learning_module.EvidenceGraphLM}
        learning_module_args:
          max_match_distance: 0.01
          # Tolerances within which features must match stored values in order to add
          # evidence to a hypothesis.
          tolerances:
            patch:
              hsv: ${np.array:[0.05, 0.1, 0.1]}
              principal_curvatures_log: [1, 1]
          feature_weights:
            patch:
              # Weighting saturation and value less since these might change under different
              # lighting conditions.
              hsv: ${np.array:[1, 0.5, 0.5]}
          x_percent_threshold: 20
          # Thresholds to use for when two points are considered different enough to
          # both be stored in memory.
          graph_delta_thresholds:
            patch:
              distance: 0.01
              pose_vectors: ${np.array:[np.pi / 8, np.pi * 2, np.pi * 2]}
              principal_curvatures_log: [1.0, 1.0]
              hsv: [0.1, 1, 1]
          # object_evidence_threshold sets a minimum threshold on the amount of evidence we have
          # for the current object in order to converge; while we can also set min_steps
          # for the experiment, this puts a more stringent requirement that we've had
          # many steps that have contributed evidence.
          object_evidence_threshold: 100
          # Symmetry evidence (indicating possibly symmetry in rotations) increments a lot
          # after 100 steps and easily reaches the default required evidence. The below
          # parameter value partially addresses this, altough we note these are temporary
          # fixes and we intend to implement a more principled approach in the future.
          required_symmetry_evidence: 20
          hypotheses_updater_args:
            max_nneighbors: 5
  train_env_interface_class: ${monty.class:tbp.monty.frameworks.environments.embodied_data.InformedEnvironmentInterface}
  train_env_interface_args:
    object_names:
      - mug
      - bowl
    object_init_sampler:
      _target_: tbp.monty.frameworks.environments.object_init_samplers.RandomRotation
